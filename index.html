<!DOCTYPE html>
<html>
<head>
    <title>La Espa√±ita despoblada: heatmap</title>
    <meta charset="utf-8" />
    <link href="/_styles/normalize.css" rel="stylesheet" type="text/css">
    <meta name="viewport" content="width=device-width">
    <script type='text/javascript' src='jquery-3.4.1.min.js'></script>
    <script type='text/javascript'>

      let BASEYEAR = 1999;
      let finalYear = 2018;

      let year = BASEYEAR;
      let yearInterval = 0.082;
      let yearIntervalOld = 0.1;
      let maxPopulation = 400;

      let yearsdata = [];
      let yearscount = BASEYEAR;

      let months = [ "January", "February", "March", "April", "May", "June",
           "July", "August", "September", "October", "November", "December" ];

      function loading(visible) {
        if (visible) {
            document.getElementById('loadingOverlay').style.display="block";
        } else {
            document.getElementById('loadingOverlay').style.display="none";
        }
      }

      function info(visible) {
        if (visible) {
            document.getElementById('infoOverlay').style.display="block";
        } else {
            document.getElementById('infoOverlay').style.display="none";
        }
      }

      function updateOverlayYear(y){
        var myDiv = document.getElementById("infoOverlay");
        let date = months[Math.floor(12*(y%1)).toString()] + ", " + Math.floor(y).toString();

        myDiv.innerHTML = date + "\n<progress id=\"progressBar\" max=\"100\" value=" + (100*(y-BASEYEAR)/(finalYear-BASEYEAR)).toString() + "></progress>";
      }

      function getGender(){
        let both = document.getElementById("Both").checked;
        let male = document.getElementById("Male").checked;
        let female = document.getElementById("Female").checked;

        /*
          gender = 0 -> total
          gender = 1 -> men
          gender = 2 -> woman
        */

        return both * 0 + male * 1 + female * 2;
      }

      function getdata(year){
        var httpr = new XMLHttpRequest();
        httpr.open("GET", "INEdata/Poblacion" + year + ".json", false);
        httpr.send(null);
        return JSON.parse(httpr.responseText);
      }

      function lerp(a, b, f){
        return  (a * (1.0 - f)) + (b * f);
      }

      function GetMap() {
        let pos = [40.098388671875, -4.043139934539795];
        var map = new Microsoft.Maps.Map('#myMap', {
          credentials: "AhDgOTA-iLKJ8ovYzesQjwB1wPIoyEYUjf6rj8wp6290h8BoHoTVSajFChVkFQV6",
          mapTypeId: Microsoft.Maps.MapTypeId.canvasDark,
          labelOverlay: Microsoft.Maps.LabelOverlay.hidden,
          center: new Microsoft.Maps.Location(pos[0],pos[1]),
          zoom: 7,
          options: {
            "allowHidingLabelsOfRoad": true,
            "enableClickableLogo": false,
            "liteMode": true
          }
        });

        console.log(getGender());

        loading(true)
        download();
        loading(false)

        Microsoft.Maps.loadModule(['Microsoft.Maps.GeoJson', 'Microsoft.Maps.HeatMap'], function () {
          let shapes = [new Microsoft.Maps.Location(0,0)];
          var heatmap = new Microsoft.Maps.HeatMapLayer(shapes,
            {
              weight: 0.001,
              intensity: 0.1,
              radius: 10,
              units: 'metres',
              aggregateLocationWeights: true
            });

          map.layers.insert(heatmap);
          console.log("heatmap done");

          setTimeout(function(){updatePrintout(heatmap, 80);}, 1000);

        });
      }

      function f(x){
        return Math.pow(x, 4)/1500000000+100;
      }

      function download() {
        var s1;
        for(var i=0; i<finalYear-BASEYEAR+1; i++) {
          s1 = new Date().getTime();
          yearsdata.push(getdata(BASEYEAR+i));
          console.log("loaded " + (BASEYEAR+i).toString() + " in " + ((new Date().getTime()-s1)/1000).toString() + "s");
        }
      }

      function updatePrintout(heatmap, delay){
        setTimeout(function () {
          //let s1 = new Date().getTime();
          getLocations3(year).then(function(x) {
            let points = []

            for(let i = 0; i<x.length; i++){
              points = points.concat(x[i]);
            }

            heatmap.setLocations(points);
          });

          //console.log("The year " + year + " computed in: " + ((new Date().getTime()-s1)/1000).toString() + "s");

          updateOverlayYear(year);

          if(year+yearInterval<finalYear-yearInterval*2){
            year = year+yearInterval
          }else {
            year = BASEYEAR
          }

          updatePrintout(heatmap, delay);
        }, delay);
      }

      function getNumberPoints(element1, element2, population, yearf){

        let pp = [];
        let coordinates = element1["geometry"]["coordinates"];

        let x = maxPopulation;

        for(let i=5; i>=0; i--) {
          if(population<x) {
            pp.push(new Microsoft.Maps.Location(parseFloat(coordinates[0]) + 0.0001*(Math.random()-0.5),parseFloat(coordinates[1]) + 0.0001*(Math.random()-0.5)));
            x = f(x);
          }else {
            break;
          }
        }

        return pp;
      }

      async function getLocations3(yearf) {
        let mag;
        switch (getGender()) {
          case 0:
            mag = "total";
          break;

          case 1:
            mag = "hombres";
          break;

          case 2:
            mag = "mujeres";
          break;

          default:
            mag = "total";
        }

        let y1 = Math.floor(yearf);
        let y2 = Math.ceil(yearf);

        let features1 = yearsdata[y1-BASEYEAR];
        let features2 = yearsdata[y2-BASEYEAR];

        if(typeof features1 === 'undefined' || typeof features2 === 'undefined'){
          return [];
        }
        let promises = [];
        let element1 = features1["Features"];
        let element2 = features2["Features"];
        for(let j = 0; j<element1.length && j<element2.length; j++) {
          let population = lerp(element1[j]["properties"][mag], element2[j]["properties"][mag], yearf%1);

          if(population<=maxPopulation){
            promises.push(getNumberPoints(element1[j], element2[j], population, yearf));
          }
        }

        return Promise.all(promises);
      }
    </script>
    <script type='text/javascript' src='http://www.bing.com/api/maps/mapcontrol?callback=GetMap' async defer></script>
</head>
<body>
    <div id="myMap"></div>
    <div id="loadingOverlay">
        <br /><br /><br /><br /><br />
        Loading...
    </div>
    <div id="infoOverlay">
      <progress id="progressBar" max="100" value="0"></progress>
    </div>
    <div id="genderSelect">
      <input type="radio" name="gender" id="Both" checked=true>Both
      <br><input type="radio" name="gender" id="Male">Male
      <br><input type="radio" name="gender" id="Female">Female
    </div>
</body>
</html>
