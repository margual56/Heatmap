<!DOCTYPE html>
<html>
<head>
    <title></title>
    <meta charset="utf-8" />
    <link href="/_styles/normalize.css" rel="stylesheet" type="text/css">
    <meta name="viewport" content="width=device-width">
    <script type='text/javascript'>
    let BASEYEAR = 1998
    //let heatmap;
    let poblacion;
    let comunidad;
    let year;

    let yearsdata = [];

    const locations = JSON.parse(getphp());

    function getLocation(str){
    var httpreq = new XMLHttpRequest();
    httpreq.open("GET","https://dev.virtualearth.net/REST/v1/Locations?query=" + str + "&key=AhDgOTA-iLKJ8ovYzesQjwB1wPIoyEYUjf6rj8wp6290h8BoHoTVSajFChVkFQV6",false);
    httpreq.send(null);
    return httpreq.responseText;          
}


    function getphp() {
        var httpr = new XMLHttpRequest();
        httpr.open("GET", "locations.json",false);
        httpr.send(null);
        return httpr.responseText;
    }

    function getdata(anio) {
        var httpr = new XMLHttpRequest();
        httpr.open("GET", "http://team10.osnola.es/geojson.php?anio=" + anio.toString(),false);
        httpr.send(null);
        return httpr.responseText;
    }

    function getquery(anio, comm) {
        var httpr = new XMLHttpRequest();
        console.log("AAA");
        console.log("pidiendo " + comm + " año " + anio.toString());
        
        httpr.open("GET", "http://team10.osnola.es/geojson.php?anio=" + anio.toString() + "&comunidad=" + comm,false);
        console.log("AAAA");
        httpr.send(null);
        console.log("AAAAA");
        return httpr.responseText;
    }

    function weightedMag(sitio, aniofloat, sex) {
        var p = sitio.split(' - ');
        console.log(p);
        
        var y1 = Math.floor(aniofloat);
        var y2 = Math.ceil(aniofloat);
        console.log(aniofloat);
        
        var data = JSON.parse(getquery(y1, p[1]).replace(".", ""));
        console.log("AA");
        
        console.log(data);
        var mag1 = data["features"][0]["properties"]["mag"];
        console.log(mag1);
        
        data = JSON.parse(getquery(y2, p[1].replace(".", "")));
        console.log(data);
        var mag2 = data["features"][0]["properties"]["mag"];
        console.log(mag2);

        return lerp(mag1, mag2, aniofloat%1);
    }

    function lerp(a, b, f) 
    {
    return  (a * (1.0 - f)) + (b * f);
    };

    function GetMap() {
        console.log(locations);
        
        var divmap = document.getElementById("myMap").setAttribute("height", document.documentElement.clientHeight-10)

        //var loc = JSON.parse(getLocation("Chozas de Canales - España"));
        //console.log(loc);
        
        let data = JSON.parse(getphp());
        console.log(data);
        
        let pos = [40.098388671875, -4.043139934539795];
        var map = new Microsoft.Maps.Map('#myMap', {
            credentials: "AhDgOTA-iLKJ8ovYzesQjwB1wPIoyEYUjf6rj8wp6290h8BoHoTVSajFChVkFQV6",
            mapTypeId: Microsoft.Maps.MapTypeId.road,
            center: new Microsoft.Maps.Location(pos[0],pos[1]),
            zoom: 7
        });
        

        download();
        Microsoft.Maps.loadModule(['Microsoft.Maps.GeoJson', 'Microsoft.Maps.HeatMap'], function () {
            let shapes = [new Microsoft.Maps.Location(0,0)];
            var heatmap = new Microsoft.Maps.HeatMapLayer(shapes, {
                        weight: 0.1,
                        intensity: 0.1,
                        radius: 10,
                        aggregateLocationWeights: true
                    });
            map.layers.insert(heatmap);
            console.log("heatmap done");
            
            updatePrintout(heatmap, map, 2000.3, 0);
        });
    };

    function download() {
        var s1;
        for(var i=0; i<4; i++) {
            s1 = new Date().getTime();
            yearsdata.push(JSON.parse(getdata(BASEYEAR+i)));
            console.log("loaded " + (BASEYEAR+i).toString() + " in " + (new Date().getTime()-s1).toString());
            
        }
    }
    

    function updatePrintout(heatmap, map, time, delay){
                  //setTimeout(function () {
                        heatmap.setLocations(getLocations3(map, 2000.3));

                    //updatePrintout(map, time, delay);
                    //}, delay);
                }

    function getLocations3(map, yearf) {
                    console.log("getlocations start");
                    

                    var y1 = Math.floor(yearf);
                    var y2 = Math.ceil(yearf);
                    var pp = [];
                    console.log("foreach start");
                    console.log(yearsdata);
                    let features;
                    for(var i = 0; i<yearsdata.length;i++) {
                        features = yearsdata[i];
                        console.log(features);
                        var element;
                        for(var j = 0; j<features["features"].length;j++) {
                            element = features["features"][j];
                            //console.log(element);
                            
                            pp.push([element["properties"]["mag"].replace(".", ""), element["geometry"]["coordinates"].map(function(x){return x.replace(',', '.')})]);
                            //console.log([element["properties"]["mag"].replace(".", ""), element["geometry"]["coordinates"].map(function(x){return x.replace(',', '.')})]);
                            
                        }
                    };

                    console.log(pp);
                    //var points = [new Microsoft.Maps.Location(pp[0][1][1], pp[0][1][0])];
                    var points = [];
                    for(var j = 0; j<pp.length; j++) {
                        var x = 10000;
                        for(var i=10; i>0; i--) {
                            if(parseFloat(pp[j][0])<x) {
                                points.push(new Microsoft.Maps.Location(parseFloat(pp[j][1][1]) + 0.0001*(Math.random()-0.5),parseFloat(pp[j][1][0]) + 0.0001*(Math.random()-0.5)));
                                x = Math.pow(x, 1/1.2);
                            }
                            else {
                                break;
                            }
                            
                        }
                    }
                
                    

                    return points;
                };


    </script>
    <script type='text/javascript' src='http://www.bing.com/api/maps/mapcontrol?callback=GetMap' async defer></script>
</head>
<body>
    <div id="myMap" style="position: absolute;margin-left: 0em;margin-top: 0em;"></div>
</body>
</html>