<!DOCTYPE html>
<html>
<head>
    <title>La Espa√±a despoblada: heatmap</title>
    <meta charset="utf-8" />
    <link href="/_styles/normalize.css" rel="stylesheet" type="text/css">
    <meta name="viewport" content="width=device-width">
    <script type='text/javascript' src='jquery-3.4.1.min.js'></script>
    <script type='text/javascript'>

      let BASEYEAR = 1999;
      let finalYear = 2018;

      let year = BASEYEAR;
      let yearInterval = 0.01;
      let yearIntervalOld = 0.1;
      let maxPopulation = 400;

      /*
        gender = 0 -> total
        gender = 1 -> men
        gender = 2 -> woman
      */
      let gender = 0;

      let yearsdata = [];
      let yearscount = BASEYEAR;

      function loading(visible) {
        if (visible) {
            document.getElementById('overlay').style.display="block";
        } else {
            document.getElementById('overlay').style.display="none";
        }
      }

      function getdata(year){
        var httpr = new XMLHttpRequest();
        httpr.open("GET", "INEdata/Poblacion" + year + ".json", false);
        httpr.send(null);
        return JSON.parse(httpr.responseText);
      }

      function lerp(a, b, f){
        return  (a * (1.0 - f)) + (b * f);
      }

      function GetMap() {
        let pos = [40.098388671875, -4.043139934539795];
        var map = new Microsoft.Maps.Map('#myMap', {
          credentials: "AhDgOTA-iLKJ8ovYzesQjwB1wPIoyEYUjf6rj8wp6290h8BoHoTVSajFChVkFQV6",
          mapTypeId: Microsoft.Maps.MapTypeId.aerial,
          center: new Microsoft.Maps.Location(pos[0],pos[1]),
          zoom: 7,
          options: {
            "allowHidingLabelsOfRoad": true,
            "enableClickableLogo": false,
            "liteMode": true
          }
        });

        loading(true)
        download();
        loading(false)

        Microsoft.Maps.loadModule(['Microsoft.Maps.GeoJson', 'Microsoft.Maps.HeatMap'], function () {
          let shapes = [new Microsoft.Maps.Location(0,0)];
          var heatmap = new Microsoft.Maps.HeatMapLayer(shapes,
            {
              weight: 0.001,
              intensity: 0.1,
              radius: 10,
              units: 'metres',
              aggregateLocationWeights: true
            });

          map.layers.insert(heatmap);
          console.log("heatmap done");

          setTimeout(updatePrintout(heatmap, 1), 2000);
        });
      }

      function f(x){
        return Math.pow(x, 4)/1500000000+100;
      }

      function download() {
        var s1;
        for(var i=0; i<finalYear-BASEYEAR+1; i++) {
          s1 = new Date().getTime();
          yearsdata.push(getdata(BASEYEAR+i));
          console.log("loaded " + (BASEYEAR+i).toString() + " in " + ((new Date().getTime()-s1)/1000).toString() + "s");
        }

        console.log(yearsdata)
      }

      function updatePrintout(heatmap, delay){
        setTimeout(function () {
          //console.log("Year" + time);
          let s1 = new Date().getTime();
          heatmap.setLocations(getLocations3(year));
          //console.log("The year " + time + " computed in: " + ((new Date().getTime()-s1)/1000).toString() + "s");

          if(year+yearInterval<finalYear-yearInterval*2){
            year = year+yearInterval
            updatePrintout(heatmap, delay);
          }
          else {
            year = BASEYEAR
            updatePrintout(heatmap, delay);
          }
        }, delay);
      }

      function getLocations3(yearf) {
        let mag;
        switch (gender) {
          case 0:
            mag = "total";
          break;

          case 1:
            mag = "hombres";
          break;

          case 2:
            mag = "mujeres";
          break;

          default:
            mag = "total";
        }

        let y1 = Math.floor(yearf);
        let y2 = Math.ceil(yearf);
        let pp = [];

        let features1 = yearsdata[y1-BASEYEAR];
        let features2 = yearsdata[y2-BASEYEAR];

        if(typeof features1 === 'undefined' || typeof features2 === 'undefined'){
          return [];
        }

        let element1, element2, x;
        for(let j = 0; j<features1["Features"].length && j<features2["Features"].length; j++) {
          element1 = features1["Features"][j];
          element2 = features2["Features"][j];

          population = lerp(element1["properties"][mag], element2["properties"][mag], yearf%1);
          coordinates = element1["geometry"]["coordinates"];

          x = maxPopulation;

          for(let i=5; i>=0; i--) {
            if(population<x) {
              pp.push(new Microsoft.Maps.Location(parseFloat(coordinates[0]) + 0.0001*(Math.random()-0.5),parseFloat(coordinates[1]) + 0.0001*(Math.random()-0.5)));
              x = f(x);
            }else {
              break;
            }
          }
        }

        return pp;
      }
    </script>
    <script type='text/javascript' src='http://www.bing.com/api/maps/mapcontrol?callback=GetMap' async defer></script>
</head>
<body>
    <div id="myMap"></div>
    <div id="overlay" style="color:black; font-weight: bold;position:absolute;width:100%;height:100%; background-color: white; opacity:0.73; text-align: center;">
        <br /><br /><br /><br /><br />
        Loading...
    </div>
</body>
</html>
